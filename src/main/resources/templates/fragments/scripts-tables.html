<th:block th:fragment="scripts-tables">
<script>
    const debounce = (fn, waitMs) => {
        let timeoutId;
        return (...args) => {
            if (timeoutId) {
                window.clearTimeout(timeoutId);
            }
            timeoutId = window.setTimeout(() => fn(...args), waitMs);
        };
    };

    const normalizeText = (value) => (value ?? '').toString().toLowerCase();

    // Generic table handler
    const createTableHandler = ({
        bodyId,
        paginationId,
        pageInfoId,
        searchId,
        data,
        pageSize,
        searchTextFunc,
        renderRowFunc
    }) => {
        const body = document.getElementById(bodyId);
        const pagination = document.getElementById(paginationId);
        const pageInfo = document.getElementById(pageInfoId);
        const search = document.getElementById(searchId);

        let filteredData = data;
        let filteredPages = Math.max(1, Math.ceil(filteredData.length / pageSize));
        let currentPage = 1;

        const createPageButton = ({ label, targetPage, active = false, disabled = false, title = '' }) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.textContent = label;
            button.classList.add('page-btn');
            if (active) {
                button.classList.add('active');
            }
            if (disabled) {
                button.disabled = true;
            }
            if (title) {
                button.title = title;
            }
            if (!disabled && Number.isInteger(targetPage)) {
                button.addEventListener('click', () => renderPage(targetPage));
            }
            return button;
        };

        const createEllipsis = () => {
            const ellipsis = document.createElement('span');
            ellipsis.classList.add('page-ellipsis');
            ellipsis.textContent = '…';
            return ellipsis;
        };

        const buildCompactPages = (page, total) => {
            const pages = new Set();

            for (let p = 1; p <= Math.min(3, total); p += 1) {
                pages.add(p);
            }
            for (let p = Math.max(1, total - 2); p <= total; p += 1) {
                pages.add(p);
            }
            for (let p = Math.max(1, page - 1); p <= Math.min(total, page + 1); p += 1) {
                pages.add(p);
            }

            return Array.from(pages).sort((a, b) => a - b);
        };

        const renderPagination = (page) => {
            if (!pagination) {
                return;
            }

            pagination.innerHTML = '';
            const safePage = Math.min(Math.max(page, 1), filteredPages);
            const pages = buildCompactPages(safePage, filteredPages);

            pagination.appendChild(createPageButton({
                label: '−10',
                targetPage: Math.max(1, safePage - 10),
                disabled: safePage <= 1,
                title: 'Jump 10 pages back'
            }));

            let previous = null;
            pages.forEach((p) => {
                if (previous != null && p - previous > 1) {
                    pagination.appendChild(createEllipsis());
                }
                pagination.appendChild(createPageButton({
                    label: String(p),
                    targetPage: p,
                    active: p === safePage
                }));
                previous = p;
            });

            pagination.appendChild(createPageButton({
                label: '+10',
                targetPage: Math.min(filteredPages, safePage + 10),
                disabled: safePage >= filteredPages,
                title: 'Jump 10 pages forward'
            }));
        };

        const renderPage = (page) => {
            if (!body) return;
            const safePage = Math.min(Math.max(page, 1), filteredPages);
            currentPage = safePage;
            const start = (safePage - 1) * pageSize;
            const end = Math.min(start + pageSize, filteredData.length);
            body.innerHTML = '';
            for (let i = start; i < end; i += 1) {
                const row = document.createElement('tr');
                row.innerHTML = renderRowFunc(filteredData[i]);
                body.appendChild(row);
            }
            if (pageInfo) {
                pageInfo.textContent = `Showing page ${safePage} of ${filteredPages}`;
            }
            renderPagination(safePage);
        };

        const updatePagination = (page = 1) => {
            filteredPages = Math.max(1, Math.ceil(filteredData.length / pageSize));
            renderPage(Math.min(Math.max(page, 1), filteredPages));
        };

        if (search) {
            const onSearch = debounce((value) => {
                const query = normalizeText(value).trim();
                filteredData = query ? data.filter(item => searchTextFunc(item).includes(query)) : data;
                updatePagination(1);
            }, 150);
            search.addEventListener('input', (event) => {
                onSearch(event.target.value);
            });
        }

        updatePagination(currentPage);
    };

    // Samples handler
    const sampleSearchText = (sample) => [
        sample.time,
        ...(Array.isArray(sample.sources) ? sample.sources : []),
        sample.status,
        sample.latencyMs,
        sample.blockNumber,
        sample.blockHash,
        sample.parentHash,
        sample.blockTime,
        sample.finalized ? 'finalized' : '',
        sample.safe ? 'safe' : '',
        sample.invalid ? 'invalid' : '',
        sample.conflict ? 'conflict' : '',
        sample.transactionCount,
        sample.gasPriceWei
    ].join(' ').toLowerCase();

    const renderSampleRow = (s) => {
        let attestationRoundBadges = '';
        if (s.attestationSlot != null && s.status === 'NEW' && !s.safe && !s.finalized) {
            const round = s.attestationSlot;
            const maxRound = Math.min(round, 3);
            for (let i = 1; i <= maxRound; i++) {
                attestationRoundBadges += `<span class="tag tag-attestation-round-${i}" title="Attestation tracking round ${i}/3">${i}</span>`;
            }
        }

        const lifecycleBadge = s.finalized
            ? '<span class="tag tag-finalized">finalized</span>'
            : (s.safe
                ? '<span class="tag tag-safe">safe</span>'
                : (s.status === 'NEW' ? `<span class="tag tag-new">new</span>${attestationRoundBadges}` : ''));

        const resolutionBadge = s.conflict
            ? '<span class="tag tag-conflict">conflict</span>'
            : (s.invalid ? '<span class="tag tag-invalid">invalid</span>' : '');

        const statusBadgeFragments = [];
        if (lifecycleBadge) {
            statusBadgeFragments.push(lifecycleBadge);
        }
        if (resolutionBadge) {
            statusBadgeFragments.push(resolutionBadge);
        }

        const blockDisplay = s.blockNumber ? String(s.blockNumber) : '-';

        const statusText = s.status === 'NEW' ? '' : (s.status ?? '-');
        let statusDisplay = statusText;
        if (statusBadgeFragments.length > 0) {
            statusDisplay = statusText
                ? `${statusText} ${statusBadgeFragments.join(' ')}`
                : statusBadgeFragments.join(' ');
        }

        let sourceDisplay = '';
        if (s.sources && Array.isArray(s.sources)) {
            sourceDisplay = s.sources.map(src => {
                if (src === 'WS') {
                    return '<span class="tag tag-ws">WS</span>';
                } else if (src === 'HTTP') {
                    return '<span class="tag tag-http">HTTP</span>';
                }
                return '';
            }).join(' ');
        }

        return `
        <td>${s.time ?? '-'}</td>
        <td>${sourceDisplay || '-'}</td>
        <td>${statusDisplay}</td>
        <td>${s.latencyMs !== null && s.latencyMs !== undefined ? s.latencyMs + ' ms' : 'n/a'}</td>
        <td>${blockDisplay}</td>
        <td>${s.transactionCount ?? '-'}</td>
        <td>${s.gasPriceWei ? (s.gasPriceWei / 1_000_000_000).toFixed(4) : '-'}</td>
        <td><button class="button ghost sample-link" data-hash="${s.blockHash ?? ''}">Open</button></td>
    `;
    };

    createTableHandler({
        bodyId: 'samplesBody',
        paginationId: 'pagination',
        pageInfoId: 'pageInfo',
        searchId: 'samplesSearch',
        data: samples,
        pageSize: pageSize,
        searchTextFunc: sampleSearchText,
        renderRowFunc: renderSampleRow
    });

    // Anomalies handler
    const anomalySearchText = (anomaly) => [
        anomaly.time,
        anomaly.type,
        anomaly.source,
        anomaly.message,
        anomaly.id,
        anomaly.count
    ].join(' ').toLowerCase();

    const renderAnomalyRow = (a) => {
        let messageContent = a.message ?? '-';
        if (a.count > 1) {
            messageContent += ` <span class="count-badge">${a.count}</span>`;
        }

        const openButton = `<button class="button ghost anomaly-link" data-id="${a.id ?? ''}">Open</button>`;

        return `
        <td>${a.time ?? '-'}</td>
        <td>${a.type ?? '-'}</td>
        <td>${a.source ?? '-'}</td>
        <td>${messageContent}</td>
        <td>${openButton}</td>
    `;
    };

    createTableHandler({
        bodyId: 'anomaliesBody',
        paginationId: 'anomaliesPagination',
        pageInfoId: 'anomalyPageInfo',
        searchId: 'anomaliesSearch',
        data: anomalies,
        pageSize: anomalyPageSize,
        searchTextFunc: anomalySearchText,
        renderRowFunc: renderAnomalyRow
    });
</script>
</th:block>

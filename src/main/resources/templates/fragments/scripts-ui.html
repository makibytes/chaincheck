<th:block th:fragment="scripts-ui">
<script>
    // Helper functions
    const formatHash = (hash) => {
        if (!hash || hash.length < 15) return hash || '-';
        return hash.substring(0, 6) + '...' + hash.substring(hash.length - 6);
    };

    const copyBtn = (text) => {
        if (!text) return '';
        return `<button class="copy-btn" onclick="copyToClipboard('${text}')" title="Copy full hash">ðŸ“‹</button>`;
    };

    // Generic toggle function
    const createToggle = (buttonId, panelId, showText, hideText) => {
        const toggleButton = document.getElementById(buttonId);
        const panel = document.getElementById(panelId);
        const section = toggleButton ? toggleButton.closest('.panel') : null;
        if (toggleButton && panel) {
            toggleButton.addEventListener('click', () => {
                const collapsed = panel.classList.toggle('collapsed');
                toggleButton.textContent = collapsed ? showText : hideText;
                if (section) {
                    section.classList.toggle('expanded', !collapsed);
                }
            });
            if (section && !panel.classList.contains('collapsed')) {
                section.classList.add('expanded');
            }
        }
    };

    createToggle('toggleSamples', 'samplesPanel', 'Show samples', 'Hide samples');
    createToggle('toggleAnomalies', 'anomaliesPanel', 'Show anomalies', 'Hide anomalies');

    // Node select handler
    const nodeSelect = document.getElementById('nodeSelect');
    if (nodeSelect) {
        nodeSelect.addEventListener('change', () => {
            const selected = nodeSelect.value;
            const url = new URL(window.location.href);
            url.searchParams.set('node', selected);
            if (!url.searchParams.get('range')) {
                url.searchParams.set('range', '2h');
            }
            window.location.href = url.toString();
        });
    }

    // Generic modal functions
    const createModalHandlers = (modalId, contentId, closeId, openFunc, closeFunc) => {
        const modal = document.getElementById(modalId);
        const closeBtn = document.getElementById(closeId);
        const openModal = () => {
            if (modal) {
                modal.classList.remove('hidden');
                modal.setAttribute('aria-hidden', 'false');
            }
        };
        const closeModal = () => {
            if (modal) {
                modal.classList.add('hidden');
                modal.setAttribute('aria-hidden', 'true');
            }
        };
        if (closeBtn) {
            closeBtn.addEventListener('click', closeModal);
        }
        if (modal) {
            const backdrop = modal.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.addEventListener('click', closeModal);
            }
        }
        return { openModal, closeModal };
    };

    const { openModal: openAnomalyModal, closeModal: closeAnomalyModal } = createModalHandlers('anomalyModal', 'anomalyContent', 'closeAnomaly');
    const { openModal: openSampleModal, closeModal: closeSampleModal } = createModalHandlers('sampleModal', 'sampleContent', 'closeSample');

    const openAnomaly = async (id) => {
        if (!anomalyContent) {
            return;
        }
        const numericId = Number(id);
        openAnomalyModal();

        const renderDetails = (payload) => {
            if (!payload) {
                anomalyContent.innerHTML = '<p class="muted">Unable to load anomaly details.</p>';
                return;
            }
            const timeText = payload.timestamp
                ? new Date(payload.timestamp).toLocaleString()
                : (payload.time ?? '-');
            const detailsText = payload.details && String(payload.details).trim().length > 0
                ? payload.details
                : (payload.message ?? '-');

            anomalyContent.innerHTML = `
            <div class="detail-grid">
                <div><span class="label">ID</span><span>${payload.id ?? '-'}</span></div>
                <div><span class="label">Node</span><span>${payload.nodeName ?? payload.nodeKey ?? '-'}</span></div>
                <div><span class="label">Time</span><span>${timeText}</span></div>
                <div><span class="label">Type</span><span>${payload.type ?? '-'}</span></div>
                <div><span class="label">Source</span><span>${payload.source ?? '-'}</span></div>
                <div><span class="label">Block</span><span>${payload.blockNumber ?? '-'}</span></div>
                <div><span class="label">Block Hash</span><span class="hash-container">${formatHash(payload.blockHash)} ${copyBtn(payload.blockHash)}</span></div>
                <div><span class="label">Parent Hash</span><span class="hash-container">${formatHash(payload.parentHash)} ${copyBtn(payload.parentHash)}</span></div>
                <div><span class="label">Message</span><span>${payload.message ?? '-'}</span></div>
            </div>
            <div class="detail-block">
                <span class="label">Details</span>
                <pre>${detailsText}</pre>
            </div>
        `;
        };

        if (!Number.isFinite(numericId) || numericId <= 0) {
            const row = anomalies.find(entry => String(entry.id) === String(id));
            renderDetails(row);
            return;
        }

        anomalyContent.innerHTML = '<p class="muted">Loading...</p>';
        try {
            const response = await fetch(`/api/anomalies/${numericId}`);
            if (!response.ok) {
                const row = anomalies.find(entry => String(entry.id) === String(id));
                renderDetails(row);
                return;
            }
            const data = await response.json();
            if (!data.details || String(data.details).trim().length === 0) {
                const row = anomalies.find(entry => String(entry.id) === String(id));
                renderDetails({
                    ...data,
                    details: row?.details ?? data.details
                });
                return;
            }
            renderDetails(data);
        } catch (error) {
            const row = anomalies.find(entry => String(entry.id) === String(id));
            renderDetails(row);
        }
    };

    window.copyToClipboard = (text) => {
        if (!text) return;
        navigator.clipboard.writeText(text).then(() => {
            // Optional: Show visual feedback
        }).catch(err => {
            console.error('Failed to copy text: ', err);
        });
    };

    const openSampleDetails = (sample) => {
        if (!sample || !sampleContent) {
            return;
        }
        const lifecycleBadge = sample.finalized
            ? '<span class="tag tag-finalized">finalized</span>'
            : (sample.safe
                ? '<span class="tag tag-safe">safe</span>'
                : (sample.status === 'NEW' ? '<span class="tag tag-new">new</span>' : ''));

        const resolutionBadge = sample.conflict
            ? '<span class="tag tag-conflict">conflict</span>'
            : (sample.invalid ? '<span class="tag tag-invalid">invalid</span>' : '');

        const statusBadgeFragments = [];
        if (lifecycleBadge) {
            statusBadgeFragments.push(lifecycleBadge);
        }
        if (resolutionBadge) {
            statusBadgeFragments.push(resolutionBadge);
        }
        const statusBadgeHtml = statusBadgeFragments.join(' ');
        const blockDisplay = `${sample.blockNumber ?? '-'}`;
        const statusText = sample.status === 'NEW' ? '' : (sample.status ?? '-');
        const statusDisplay = statusBadgeHtml
            ? (statusText ? `${statusText} ${statusBadgeHtml}` : statusBadgeHtml)
            : statusText;
        const attestationDisplay = sample.attestationConfidence != null
            ? `${sample.attestationConfidence.toFixed(1)}%`
            : 'n/a';
        sampleContent.innerHTML = `
            <div class="detail-grid">
                <div><span class="label">Block</span><span>${blockDisplay}</span></div>
                <div><span class="label">Block Time</span><span>${sample.blockTime ?? '-'}</span></div>
                <div><span class="label">Sources</span><span>${(sample.sources || []).join(', ') || '-'}</span></div>
                <div><span class="label">Status</span><span>${statusDisplay}</span></div>
                <div><span class="label">Latency</span><span>${sample.latencyMs != null ? sample.latencyMs + ' ms' : 'n/a'}</span></div>
                <div><span class="label">Attestation</span><span>${attestationDisplay}</span></div>
                <div><span class="label">Transactions</span><span>${sample.transactionCount ?? 'n/a'}</span></div>
                <div><span class="label">Block Hash</span><span class="hash-container">${formatHash(sample.blockHash)} ${copyBtn(sample.blockHash)}</span></div>
                <div><span class="label">Parent Hash</span><span class="hash-container">${formatHash(sample.parentHash)} ${copyBtn(sample.parentHash)}</span></div>
            </div>
        `;
        openSampleModal();
    };

    const anomaliesBodyEl = document.getElementById('anomaliesBody');
    if (anomaliesBodyEl) {
        anomaliesBodyEl.addEventListener('click', (event) => {
            const target = event.target;
            if (target && target.classList && target.classList.contains('anomaly-link')) {
                event.preventDefault();
                openAnomaly(target.getAttribute('data-id'));
            }
        });
    }

    const samplesBodyEl = document.getElementById('samplesBody');
    if (samplesBodyEl) {
        samplesBodyEl.addEventListener('click', (event) => {
            const target = event.target;
            if (target && target.classList && target.classList.contains('sample-link')) {
                event.preventDefault();
                const blockHash = target.getAttribute('data-hash');
                const sample = samples.find(entry => entry.blockHash === blockHash);
                openSampleDetails(sample);
            }
        });
    }

    const chartWrapper = document.getElementById('latencyChartWrapper');
    const navLeft = document.getElementById('chartNavLeft');
    const navRight = document.getElementById('chartNavRight');
    if (chartWrapper && navLeft && navRight) {
        const rangeSteps = {
            '2h': 90 * 60 * 1000,
            '3d': (2 * 24 + 8) * 60 * 60 * 1000
        };
        const rangeFromData = chartWrapper.dataset.range;
        const rangeFromScript = typeof rangeKey !== 'undefined' ? rangeKey : null;
        const activeRange = rangeFromScript || rangeFromData || '2h';
        const stepMs = rangeSteps[activeRange];
        if (!stepMs) {
            navLeft.classList.add('disabled');
            navRight.classList.add('disabled');
        } else {
            const nowEpochMs = Date.now();
            const oldestEndEpochMs = nowEpochMs - (30 * 24 * 60 * 60 * 1000);
            const newestThresholdMs = 60 * 1000;
            let currentEndEpochMs = typeof viewEndEpochMs !== 'undefined' ? viewEndEpochMs : nowEpochMs;
            if (chartWrapper.dataset.end) {
                const parsed = Number(chartWrapper.dataset.end);
                if (!Number.isNaN(parsed)) {
                    currentEndEpochMs = parsed;
                }
            }

            const currentUrl = new URL(window.location.href);
            const endParam = currentUrl.searchParams.get('end');
            if (endParam) {
                const parsed = Number(endParam);
                if (!Number.isNaN(parsed)) {
                    currentEndEpochMs = parsed;
                }
            }

            currentEndEpochMs = Math.min(currentEndEpochMs, nowEpochMs);
            currentEndEpochMs = Math.max(currentEndEpochMs, oldestEndEpochMs);

            const isNewest = !endParam || currentEndEpochMs >= nowEpochMs - newestThresholdMs;
            const isOldest = currentEndEpochMs <= oldestEndEpochMs + newestThresholdMs;
            navRight.classList.toggle('disabled', isNewest);
            const allowLeft = !!hasOlderAggregates;
            navLeft.classList.toggle('disabled', isOldest || !allowLeft);

            const navigate = (direction) => {
                let target = currentEndEpochMs + direction * stepMs;
                target = Math.min(target, nowEpochMs);
                target = Math.max(target, oldestEndEpochMs);

                const nextUrl = new URL(window.location.href);
                if (Math.abs(target - nowEpochMs) <= newestThresholdMs) {
                    nextUrl.searchParams.delete('end');
                } else {
                    nextUrl.searchParams.set('end', String(Math.round(target)));
                }
                if (!nextUrl.searchParams.get('range')) {
                    nextUrl.searchParams.set('range', activeRange);
                }
                window.location.href = nextUrl.toString();
            };

            const updateHoverZone = (event) => {
                if (navLeft.classList.contains('disabled') && navRight.classList.contains('disabled')) {
                    chartWrapper.classList.remove('show-left', 'show-right');
                    return;
                }
                const rect = chartWrapper.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const leftZone = rect.width / 3;
                const rightZone = rect.width * 2 / 3;
                const showLeft = x >= 0 && x <= leftZone && !navLeft.classList.contains('disabled');
                const showRight = x >= rightZone && x <= rect.width && !navRight.classList.contains('disabled');
                chartWrapper.classList.toggle('show-left', showLeft);
                chartWrapper.classList.toggle('show-right', showRight);
            };

            chartWrapper.addEventListener('mousemove', updateHoverZone);
            chartWrapper.addEventListener('mouseleave', () => {
                chartWrapper.classList.remove('show-left', 'show-right');
            });

            navLeft.addEventListener('click', () => navigate(-1));
            navRight.addEventListener('click', () => navigate(1));
        }
    }
</script>
</th:block>

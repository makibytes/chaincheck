<section class="panel fleet-panel" th:fragment="fleetNodes">
    <h2>Node Fleet</h2>
    <div class="fleet-table-wrapper">
        <table class="fleet-table">
            <thead>
                <tr>
                    <th>Health <span class="hint" data-hint="Composite score 0–100 weighted from: uptime (40%), latency P95 (25%), head-delay P95 (20%), error rate (15%). Score is 0 when the node is currently down.">?</span></th>
                    <th>Node</th>
                    <th>Trend <span class="hint" data-hint="Average HTTP latency per minute over the last hour. The line height reflects relative response time — higher means slower.">?</span></th>
                    <th>Latest Block <span class="hint" data-hint="Most recent block number this node has reported. Green = highest · yellow = 1 behind · red = 2+ behind.">?</span></th>
                    <th>Age <span class="hint" data-hint="Time elapsed since this node last saw a new block. Green &lt; 15 s · amber &lt; 60 s · red ≥ 60 s.">?</span></th>
                    <th>Uptime <span class="hint" data-hint="Percentage of HTTP RPC calls that succeeded over the selected time range.">?</span></th>
                    <th>Latency P95 <span class="hint" data-hint="95th-percentile HTTP round-trip time. 95% of all requests completed within this value.">?</span></th>
                    <th>Head Delay P95 <span class="hint" data-hint="95th-percentile time between a block's own timestamp and when this node first reported it via WebSocket.">?</span></th>
                    <th>Anomalies <span class="hint" data-hint="Number of anomaly events detected in the selected range: delays, reorgs, wrong heads, timeouts, block gaps, etc.">?</span></th>
                    <th>WS <span class="hint" data-hint="WebSocket subscription status. OK = connected · Error = disconnected · Off = not configured. Number in red brackets = reconnections in the past 24 hours.">?</span></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="node : ${fleetView.nodes}" class="fleet-row"
                    th:onclick="|window.location.href='@{/dashboard(node=${node.nodeKey},range=${fleetView.range.key})}'|">
                    <td>
                        <span class="health-badge"
                            th:classappend="${node.healthScore >= 80} ? ' health-excellent' : (${node.healthScore >= 50} ? ' health-good' : (${node.healthScore >= 20} ? ' health-degraded' : ' health-down'))"
                            th:text="${node.healthScore}">0</span>
                    </td>
                    <td>
                        <span th:text="${node.nodeName}">Node</span>
                        <span th:if="${node.referenceNode}" class="ref-badge">REF</span>
                    </td>
                    <td class="fleet-sparkline-cell">
                        <svg th:if="${!#strings.isEmpty(node.latencySparklinePoints)}"
                             viewBox="0 0 60 28"
                             class="fleet-sparkline"
                             aria-hidden="true">
                            <polyline th:attr="points=${node.latencySparklinePoints}"
                                      fill="none"
                                      stroke="var(--color-primary)"
                                      stroke-width="1.5"
                                      stroke-linejoin="round"
                                      stroke-linecap="round"/>
                        </svg>
                        <span th:if="${#strings.isEmpty(node.latencySparklinePoints)}" class="muted">—</span>
                    </td>
                    <td>
                        <span th:if="${node.latestBlockNumber != null}"
                            th:classappend="${node.latestBlockNumber == fleetView.maxBlockNumber} ? ' text-success' : (${node.latestBlockNumber == fleetView.maxBlockNumber - 1} ? ' text-warn' : ' text-danger')"
                            th:text="${node.latestBlockNumber}">-</span>
                        <span th:if="${node.latestBlockNumber == null}" class="muted">-</span>
                    </td>
                    <td>
                        <span th:if="${node.lastBlockAgeMs != null}"
                            th:classappend="${node.lastBlockAgeMs < 15000 ? ' age-fresh' : (node.lastBlockAgeMs < 60000 ? ' age-warn' : ' age-stale')}"
                            th:text="${node.lastBlockAgeMs < 1000 ? node.lastBlockAgeMs + 'ms' : (node.lastBlockAgeMs < 60000 ? #numbers.formatDecimal(node.lastBlockAgeMs / 1000.0, 1, 1) + 's' : #numbers.formatDecimal(node.lastBlockAgeMs / 60000.0, 1, 1) + 'm')}">-</span>
                        <span th:if="${node.lastBlockAgeMs == null}" class="muted">-</span>
                    </td>
                    <td>
                        <span th:classappend="${node.uptimePercent >= 99} ? '' : (${node.uptimePercent >= 95} ? ' text-warn' : ' text-danger')"
                            th:text="${#numbers.formatDecimal(node.uptimePercent, 1, 1)} + '%'">-</span>
                    </td>
                    <td th:text="${node.p95LatencyMs > 0} ? ${#numbers.formatDecimal(node.p95LatencyMs, 1, 0)} + 'ms' : '-'">-</td>
                    <td th:text="${node.p95HeadDelayMs > 0} ? ${#numbers.formatDecimal(node.p95HeadDelayMs / 1000.0, 1, 2)} + 's' : '-'">-</td>
                    <td>
                        <span th:if="${node.anomalyCount > 0}" class="text-danger" th:text="${node.anomalyCount}">0</span>
                        <span th:if="${node.anomalyCount == 0}" class="muted">—</span>
                    </td>
                    <td>
                        <span th:if="${node.wsConfigured}">
                            <span th:if="${node.wsUp}" class="text-success">OK</span>
                            <span th:if="${!node.wsUp}" class="text-danger">Error</span>
                            <span th:if="${node.wsDisconnectCount > 0}" class="text-danger" th:text="' (' + ${node.wsDisconnectCount} + ')'">-</span>
                        </span>
                        <span th:if="${!node.wsConfigured}" class="muted">Off</span>
                    </td>
                    <td>
                        <a class="button ghost fleet-details-link"
                            th:href="@{/dashboard(node=${node.nodeKey},range=${fleetView.range.key})}"
                            onclick="event.stopPropagation()">Details →</a>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <p th:if="${#lists.isEmpty(fleetView.nodes)}" class="muted">No nodes configured.</p>
</section>

<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChainCheck Dashboard</title>
    <link rel="icon" type="image/svg+xml" th:href="@{/favicon.svg}" />
    <link rel="stylesheet" th:href="@{/style.css}" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@3.0.0/index.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>

<body>
    <header class="app-header">
        <div>
            <p class="title">ChainCheck<span th:if="${appTitle != null and !appTitle.isEmpty()}"
                    th:text="' 路 ' + ${appTitle}"
                    th:style="'font-weight: bold; color: ' + ${appTitleColor} + ';'"></span></p>
        </div>
        <div class="header-controls">
            <label class="select-label">
                Node:
                <select id="nodeSelect">
                    <option th:each="node : ${nodes}" th:value="${node.key}" th:selected="${node.key} == ${nodeKey}"
                        th:text="${node.name}"></option>
                </select>
            </label>
            <div class="range-selector">
                <span>Range:</span>
                <a th:each="r : ${ranges}" th:href="@{/dashboard(range=${r.key}, node=${nodeKey})}" th:text="${r.key}"
                    th:classappend="${r} == ${range} ? 'active' : ''">
                </a>
            </div>
        </div>
    </header>

    <section class="summary-grid">
        <div class="card">
            <h3>Total Samples</h3>
            <p>
                <span th:text="${view.summary.totalSamples}">0</span>
            </p>
            <p class="muted">
                HTTP <span th:text="${view.summary.httpSamples}">0</span> 路
                WS <span th:text="${view.summary.wsSamples}">0</span>
            </p>
        </div>
        <div class="card">
            <h3>Success / Errors</h3>
            <p>
                <span th:text="${view.summary.successCount}">0</span>
                <span class="muted">/</span>
                <span th:text="${view.summary.errorCount}">0</span>
            </p>
            <p class="muted">
                Uptime <span th:text="${#numbers.formatDecimal(view.summary.uptimePercent, 1, 1)}">0</span>% 路
                Error rate <span th:text="${#numbers.formatDecimal(view.summary.errorRatePercent, 1, 1)}">0</span>%
            </p>
        </div>
        <div class="card">
            <h3>Latency (avg / p95 / p99)</h3>
            <p>
                <span th:text="${#numbers.formatDecimal(view.summary.avgLatencyMs, 0, 2)}">0</span> ms
                <span class="muted">/</span>
                <span th:text="${view.summary.p95LatencyMs}">0</span> ms
                <span class="muted">/</span>
                <span th:text="${view.summary.p99LatencyMs}">0</span> ms
            </p>
        </div>
        <div class="card">
            <h3>Anomalies</h3>
            <p>
                <span>Delay:</span> <span th:text="${view.summary.delayCount}">0</span><br />
                <span>Reorg:</span> <span th:text="${view.summary.reorgCount}">0</span><br />
                <span>Block Gap:</span> <span th:text="${view.summary.blockGapCount}">0</span><br />
                <span>Stale Blocks:</span> <span th:text="${view.summary.staleBlockCount}">0</span>
            </p>
        </div>
        <div class="card">
            <h3>Block Propagation Delay</h3>
            <p>
                Avg <span th:text="${#numbers.formatDecimal(view.summary.avgPropagationDelayMs / 1000, 0, 2)}">0</span>
                s<br />
                P95 <span th:text="${#numbers.formatDecimal(view.summary.p95PropagationDelayMs / 1000, 0, 2)}">0</span>
                s<br />
                Max <span th:text="${#numbers.formatDecimal(view.summary.maxPropagationDelayMs / 1000, 0, 2)}">0</span>
                s<br />
                Lag vs best <span th:text="${view.summary.blockLagBlocks}">0</span> blocks
            </p>
        </div>
    </section>

    <section class="panel">
        <h2>RPC Status</h2>
        <div class="status-grid">
            <div class="status-item">
                <span class="status-light"
                    th:classappend="${view.httpConfigured} ? (${view.httpUp} ? ' status-http-up' : ' status-error') : ' status-off'"></span>
                <span>HTTP RPC</span>
            </div>
            <div class="status-item">
                <span class="status-light"
                    th:classappend="${view.wsConfigured} ? (${view.wsUp} ? ' status-ws-up' : ' status-error') : ' status-off'"></span>
                <span>WebSocket RPC</span>
            </div>
            <div class="status-item">
                <span class="label">Latest Block</span>
                <span th:text="${view.latestBlockNumber != null ? view.latestBlockNumber : '-'}">-</span>
            </div>
        </div>
        <div class="rpc-columns">
            <div class="rpc-column">
                <h3>HTTP</h3>
                <div class="rpc-item">
                    <span class="label">HTTP Connected</span>
                    <span
                        th:text="${view.httpStatus.connectedSince != null ? #temporals.format(view.httpStatus.connectedSince, 'yyyy-MM-dd HH:mm:ss') : '-'}">-</span>
                </div>
                <div class="rpc-item">
                    <span class="label">HTTP Connection Errors</span>
                    <span th:text="${view.httpStatus.errorCount}">0</span>
                </div>
                <div class="rpc-item">
                    <span class="label">Last Error</span>
                    <span th:text="${view.httpStatus.lastError != null ? view.httpStatus.lastError : '-'}">-</span>
                </div>
            </div>
            <div class="rpc-column">
                <h3>WebSocket</h3>
                <div class="rpc-item">
                    <span class="label">WS Connected</span>
                    <span
                        th:text="${view.wsStatus.connectedSince != null ? #temporals.format(view.wsStatus.connectedSince, 'yyyy-MM-dd HH:mm:ss') : '-'}">-</span>
                </div>
                <div class="rpc-item">
                    <span class="label">WS Connection Errors</span>
                    <span th:text="${view.wsStatus.connectFailureCount}">0</span>
                </div>
                <div class="rpc-item">
                    <span class="label">Last Error</span>
                    <span th:text="${view.wsStatus.lastError != null ? view.wsStatus.lastError : '-'}">-</span>
                </div>
            </div>
        </div>
    </section>

    <div id="anomalyModal" class="modal hidden" aria-hidden="true">
        <div class="modal-backdrop"></div>
        <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="anomalyTitle">
            <div class="modal-header">
                <h2 id="anomalyTitle">Anomaly Details</h2>
                <button type="button" class="button ghost" id="closeAnomaly">Close</button>
            </div>
            <div id="anomalyContent" class="modal-content">
                <p class="muted">Loading...</p>
            </div>
        </div>
    </div>

    <section class="panel">
        <h2>Network Latency & Error Rate</h2>
        <canvas id="latencyChart" height="120"></canvas>
    </section>

    <section class="panel" th:if="${view.wsConfigured}">
        <h2>Checkpoint Propagation Delays</h2>
        <canvas id="delayChart" height="120"></canvas>
    </section>

    <section class="panel">
        <div class="panel-header">
            <h2>Anomalies <span class="count-badge" th:text="${view.totalAnomalies}">0</span></h2>
            <button id="toggleAnomalies" class="button ghost" type="button">Show anomalies</button>
        </div>
        <div id="anomaliesPanel" class="collapsed">
            <p class="muted">
                <span id="anomalyPageInfo">Showing page 1 of 1</span>
                路 Total anomalies (max 1000): <span th:text="${view.totalAnomalies}">0</span>
            </p>
            <div id="anomalyEmpty" class="empty" th:if="${#lists.isEmpty(view.anomalies)}">No anomalies in this range.
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Type</th>
                        <th>Source</th>
                        <th>Message</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="anomaliesBody"></tbody>
            </table>
            <div class="pagination" id="anomaliesPagination"></div>
        </div>
    </section>

    <section class="panel">
        <div class="panel-header">
            <h2>Samples <span class="count-badge" th:text="${view.totalSamples}">0</span></h2>
            <button id="toggleSamples" class="button ghost" type="button">Show samples</button>
        </div>
        <div id="samplesPanel" class="collapsed">
            <p class="muted">
                <span id="pageInfo">Showing page 1 of 1</span>
                路 Total samples (max 1000): <span th:text="${view.totalSamples}">0</span>
            </p>
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Source</th>
                        <th>Status</th>
                        <th>Latency</th>
                        <th>Block</th>
                        <th>Transactions</th>
                        <th>Gas Price (gwei)</th>
                    </tr>
                </thead>
                <tbody id="samplesBody"></tbody>
            </table>
            <div class="pagination" id="pagination"></div>
        </div>
    </section>

    <script th:inline="javascript">
        const timestamps = /*[[${view.chartTimestamps}]]*/[];
        const labels = /*[[${view.chartLabels}]]*/[];
        const latencyData = /*[[${view.chartLatencies}]]*/[];
        const errorRateData = /*[[${view.chartErrorRates}]]*/[];
        const wsErrorRateData = /*[[${view.chartWsErrorRates}]]*/[];
        const headDelayData = /*[[${view.chartHeadDelays}]]*/[];
        const safeDelayData = /*[[${view.chartSafeDelays}]]*/[];
        const finalizedDelayData = /*[[${view.chartFinalizedDelays}]]*/[];
        const wsConfigured = /*[[${view.wsConfigured}]]*/ false;
        const safeBlocksEnabled = /*[[${view.safeBlocksEnabled}]]*/ false;
        const samples = /*[[${view.sampleRows}]]*/[];
        const anomalies = /*[[${view.anomalyRows}]]*/[];
        const pageSize = /*[[${view.pageSize}]]*/ 50;
        const totalPages = /*[[${view.totalPages}]]*/ 1;
        const anomalyPageSize = /*[[${view.anomalyPageSize}]]*/ 50;
        const anomalyTotalPages = /*[[${view.anomalyTotalPages}]]*/ 1;

        const ctx = document.getElementById('latencyChart');
        if (ctx) {
            const datasets = [{
                label: 'Latency (ms)',
                data: latencyData,
                borderColor: '#2b4cff',
                backgroundColor: 'rgba(43, 76, 255, 0.2)',
                spanGaps: true,
                tension: 0.2,
                yAxisID: 'y'
            }, {
                label: 'HTTP Error rate (%)',
                data: errorRateData,
                borderColor: '#ff5c5c',
                backgroundColor: 'rgba(255, 92, 92, 0.2)',
                spanGaps: true,
                tension: 0.2,
                yAxisID: 'y1'
            }];
            if (wsConfigured) {
                datasets.push({
                    label: 'WS error rate (%)',
                    data: wsErrorRateData,
                    borderColor: '#a855f7',
                    backgroundColor: 'rgba(168, 85, 247, 0.2)',
                    spanGaps: true,
                    tension: 0.2,
                    yAxisID: 'y1'
                });
            }

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        x: {
                            display: true,
                            ticks: {
                                color: '#8b93a7',
                                display: true,
                                maxRotation: 45,
                                minRotation: 0
                            },
                            grid: { color: '#20263a' }
                        },
                        y: {
                            min: 0,
                            ticks: {
                                color: '#8b93a7',
                                callback: (value) => `${value} ms`
                            },
                            grid: { color: '#20263a' }
                        },
                        y1: {
                            position: 'right',
                            min: 0,
                            max: 2,
                            ticks: {
                                color: '#ff8c8c',
                                callback: (value) => `${value}`
                            },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        const delayCtx = document.getElementById('delayChart');
        if (delayCtx) {
            const delayDatasets = [{
                label: 'Head Delay (ms)',
                data: headDelayData,
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.2)',
                spanGaps: true,
                tension: 0.2,
                yAxisID: 'y'
            }];

            if (safeBlocksEnabled) {
                delayDatasets.push({
                    label: 'Safe Delay (ms)',
                    data: safeDelayData,
                    borderColor: '#eab308',
                    backgroundColor: 'rgba(234, 179, 8, 0.2)',
                    spanGaps: true,
                    tension: 0.2,
                    yAxisID: 'y'
                });
            }

            delayDatasets.push({
                label: 'Finalized Delay (ms)',
                data: finalizedDelayData,
                borderColor: '#22c55e',
                backgroundColor: 'rgba(34, 197, 94, 0.2)',
                spanGaps: true,
                tension: 0.2,
                yAxisID: 'y'
            });

            new Chart(delayCtx, {
                type: 'line',
                data: {
                    labels,
                    datasets: delayDatasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        x: {
                            display: true,
                            ticks: {
                                color: '#8b93a7',
                                display: true,
                                maxRotation: 45,
                                minRotation: 0
                            },
                            grid: { color: '#20263a' }
                        },
                        y: {
                            min: 0, ticks: {
                                color: '#8b93a7',
                                callback: (value) => `${value} ms`
                            },
                            grid: { color: '#20263a' }
                        }
                    }
                }
            });
        }

        const samplesBody = document.getElementById('samplesBody');
        const pagination = document.getElementById('pagination');
        const pageInfo = document.getElementById('pageInfo');

        const renderPage = (page) => {
            if (!samplesBody) {
                return;
            }
            const safePage = Math.min(Math.max(page, 1), totalPages);
            const start = (safePage - 1) * pageSize;
            const end = Math.min(start + pageSize, samples.length);
            samplesBody.innerHTML = '';
            for (let i = start; i < end; i += 1) {
                const s = samples[i];

                // Build block display with finalized tag if applicable
                let blockDisplay = s.blockNumber ? String(s.blockNumber) : '-';
                if (s.blockNumber && s.finalized) {
                    blockDisplay += ' <span class="tag tag-finalized">finalized</span>';
                }

                // Build source display with multiple tags if applicable
                let sourceDisplay = '';
                if (s.sources && Array.isArray(s.sources)) {
                    sourceDisplay = s.sources.map(src => {
                        if (src === 'WS') {
                            return '<span class="tag tag-ws">WS</span>';
                        } else if (src === 'HTTP') {
                            return '<span class="tag tag-http">HTTP</span>';
                        }
                        return '';
                    }).join(' ');
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                <td>${s.time ?? '-'}</td>
                <td>${sourceDisplay || '-'}</td>
                <td>${s.status ?? '-'}</td>
                <td>${s.latencyMs !== null && s.latencyMs !== undefined ? s.latencyMs + ' ms' : 'n/a'}</td>
                <td>${blockDisplay}</td>
                <td>${s.transactionCount ?? '-'}</td>
                <td>${s.gasPriceWei ? (s.gasPriceWei / 1_000_000_000).toFixed(4) : '-'}</td>
            `;
                samplesBody.appendChild(row);
            }
            if (pageInfo) {
                pageInfo.textContent = `Showing page ${safePage} of ${totalPages}`;
            }
            if (pagination) {
                Array.from(pagination.children).forEach((child, index) => {
                    child.classList.toggle('active', index + 1 === safePage);
                });
            }
        };

        if (pagination) {
            pagination.innerHTML = '';
            for (let p = 1; p <= totalPages; p += 1) {
                const link = document.createElement('a');
                link.href = '#';
                link.textContent = String(p);
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    renderPage(p);
                });
                pagination.appendChild(link);
            }
        }

        renderPage(1);

        const anomaliesBody = document.getElementById('anomaliesBody');
        const anomaliesPagination = document.getElementById('anomaliesPagination');
        const anomalyPageInfo = document.getElementById('anomalyPageInfo');

        const renderAnomalies = (page) => {
            if (!anomaliesBody) {
                return;
            }
            const safePage = Math.min(Math.max(page, 1), anomalyTotalPages);
            const start = (safePage - 1) * anomalyPageSize;
            const end = Math.min(start + anomalyPageSize, anomalies.length);
            anomaliesBody.innerHTML = '';
            for (let i = start; i < end; i += 1) {
                const a = anomalies[i];
                const row = document.createElement('tr');

                let messageContent = a.message ?? '-';
                if (a.count > 1) {
                    messageContent += ` <span class="count-badge">${a.count}</span>`;
                }

                row.innerHTML = `
                <td>${a.time ?? '-'}</td>
                <td>${a.type ?? '-'}</td>
                <td>${a.source ?? '-'}</td>
                <td>${messageContent}</td>
                <td><button class="button ghost anomaly-link" data-id="${a.id}">Open</button></td>
            `;
                anomaliesBody.appendChild(row);
            }
            if (anomalyPageInfo) {
                anomalyPageInfo.textContent = `Showing page ${safePage} of ${anomalyTotalPages}`;
            }
            if (anomaliesPagination) {
                Array.from(anomaliesPagination.children).forEach((child, index) => {
                    child.classList.toggle('active', index + 1 === safePage);
                });
            }
        };

        if (anomaliesPagination) {
            anomaliesPagination.innerHTML = '';
            for (let p = 1; p <= anomalyTotalPages; p += 1) {
                const link = document.createElement('a');
                link.href = '#';
                link.textContent = String(p);
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    renderAnomalies(p);
                });
                anomaliesPagination.appendChild(link);
            }
        }

        renderAnomalies(1);
    </script>

    <script>
        const toggleButton = document.getElementById('toggleSamples');
        const samplesPanel = document.getElementById('samplesPanel');
        if (toggleButton && samplesPanel) {
            toggleButton.addEventListener('click', () => {
                const collapsed = samplesPanel.classList.toggle('collapsed');
                toggleButton.textContent = collapsed ? 'Show samples' : 'Hide samples';
            });
        }

        const toggleAnomalies = document.getElementById('toggleAnomalies');
        const anomaliesPanel = document.getElementById('anomaliesPanel');
        if (toggleAnomalies && anomaliesPanel) {
            toggleAnomalies.addEventListener('click', () => {
                const collapsed = anomaliesPanel.classList.toggle('collapsed');
                toggleAnomalies.textContent = collapsed ? 'Show anomalies' : 'Hide anomalies';
            });
        }

        const nodeSelect = document.getElementById('nodeSelect');
        if (nodeSelect) {
            nodeSelect.addEventListener('change', () => {
                const selected = nodeSelect.value;
                const url = new URL(window.location.href);
                url.searchParams.set('node', selected);
                if (!url.searchParams.get('range')) {
                    url.searchParams.set('range', '2h');
                }
                window.location.href = url.toString();
            });
        }

        const anomalyModal = document.getElementById('anomalyModal');
        const anomalyContent = document.getElementById('anomalyContent');
        const closeAnomaly = document.getElementById('closeAnomaly');
        const openModal = () => {
            if (anomalyModal) {
                anomalyModal.classList.remove('hidden');
                anomalyModal.setAttribute('aria-hidden', 'false');
            }
        };
        const closeModal = () => {
            if (anomalyModal) {
                anomalyModal.classList.add('hidden');
                anomalyModal.setAttribute('aria-hidden', 'true');
            }
        };
        if (closeAnomaly) {
            closeAnomaly.addEventListener('click', closeModal);
        }
        if (anomalyModal) {
            const backdrop = anomalyModal.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.addEventListener('click', closeModal);
            }
        }

        const openAnomaly = async (id) => {
            if (!id || !anomalyContent) {
                return;
            }
            anomalyContent.innerHTML = '<p class="muted">Loading...</p>';
            openModal();
            try {
                const response = await fetch(`/api/anomalies/${id}`);
                if (!response.ok) {
                    anomalyContent.innerHTML = '<p class="muted">Unable to load anomaly details.</p>';
                    return;
                }
                const data = await response.json();
                const timeText = data.timestamp ? new Date(data.timestamp).toLocaleString() : '-';
                const formatHash = (hash) => {
                    if (!hash || hash.length < 15) return hash || '-';
                    return hash.substring(0, 6) + '...' + hash.substring(hash.length - 6);
                };
                const copyBtn = (text) => {
                    if (!text) return '';
                    return `<button class="copy-btn" onclick="copyToClipboard('${text}')" title="Copy full hash"></button>`;
                };

                anomalyContent.innerHTML = `
                <div class="detail-grid">
                    <div><span class="label">ID</span><span>${data.id ?? '-'}</span></div>
                    <div><span class="label">Node</span><span>${data.nodeName ?? '-'}</span></div>
                    <div><span class="label">Time</span><span>${timeText}</span></div>
                    <div><span class="label">Type</span><span>${data.type ?? '-'}</span></div>
                    <div><span class="label">Source</span><span>${data.source ?? '-'}</span></div>
                    <div><span class="label">Block</span><span>${data.blockNumber ?? '-'}</span></div>
                    <div><span class="label">Block Hash</span><span class="hash-container">${formatHash(data.blockHash)} ${copyBtn(data.blockHash)}</span></div>
                    <div><span class="label">Parent Hash</span><span class="hash-container">${formatHash(data.parentHash)} ${copyBtn(data.parentHash)}</span></div>
                    <div><span class="label">Message</span><span>${data.message ?? '-'}</span></div>
                </div>
                <div class="detail-block">
                    <span class="label">Details</span>
                    <pre>${data.details ?? '-'}</pre>
                </div>
            `;
            } catch (error) {
                anomalyContent.innerHTML = '<p class="muted">Unable to load anomaly details.</p>';
            }
        };

        window.copyToClipboard = (text) => {
            if (!text) return;
            navigator.clipboard.writeText(text).then(() => {
                // Optional: Show visual feedback
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        };

        const anomaliesBodyEl = document.getElementById('anomaliesBody');
        if (anomaliesBodyEl) {
            anomaliesBodyEl.addEventListener('click', (event) => {
                const target = event.target;
                if (target && target.classList && target.classList.contains('anomaly-link')) {
                    event.preventDefault();
                    openAnomaly(target.getAttribute('data-id'));
                }
            });
        }
    </script>
</body>

</html>